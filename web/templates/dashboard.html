{% extends "base.html" %}

{% block content %}

{% if error %}
<div class="alert danger">
    âš ï¸  SYSTEM ERROR: {{ error }}
</div>
{% endif %}

{% if status and status.has_data %}

<!-- Status Grid -->
<div class="status-grid">
    <!-- Last Fill -->
    <div class="status-card">
        <h3>ğŸ“‹ LAST FILL</h3>
        <div class="label">Date:</div>
        <div class="value success">{{ status.fill.date.strftime('%B %d, %Y') }}</div>
        <div class="label">Quantity:</div>
        <div class="value success">{{ status.fill.quantity }} pills</div>
        <div class="label">Pharmacy:</div>
        <div class="value success">{{ status.fill.pharmacy }}</div>
        <div class="label">Rx Number:</div>
        <div class="value success">{{ status.fill.prescription_number }}</div>
        <div class="label">Days Ago:</div>
        <div class="value success">{{ status.fill.days_ago }} days</div>
    </div>

    <!-- Refill Status -->
    <div class="status-card">
        <h3>ğŸ”„ REFILL STATUS</h3>
        <div class="label">Eligible Date:</div>
        <div class="value {% if status.refill.can_refill %}success{% elif status.refill.days_until <= 3 %}warning{% endif %}">
            {{ status.refill.eligible_date.strftime('%B %d, %Y') }}
        </div>
        <div class="label">Status:</div>
        <div class="value {% if status.refill.can_refill %}success{% elif status.refill.days_until <= 3 %}warning{% endif %}">
            {% if status.refill.can_refill %}
                âœ… CAN REFILL NOW!
            {% elif status.refill.days_until <= 3 %}
                â° {{ status.refill.days_until }} DAYS UNTIL ELIGIBLE
            {% else %}
                â³ {{ status.refill.days_until }} DAYS UNTIL ELIGIBLE
            {% endif %}
        </div>
    </div>

    {% if status.distribution %}
    <!-- Distribution Status -->
    <div class="status-card">
        <h3>ğŸ‘¤ EX-WIFE STATUS</h3>
        <div class="label">Last Distribution:</div>
        <div class="value success">
            {{ status.distribution.date.strftime('%B %d, %Y') }}<br>
            ({{ status.distribution.quantity }} pills)
        </div>
        <div class="label">Total Distributed:</div>
        <div class="value success">{{ status.distribution.total_distributed }} pills</div>
        <div class="label">Runs Out:</div>
        <div class="value {% if status.distribution.is_out %}danger{% elif status.distribution.days_until_out <= 3 %}warning{% else %}success{% endif %}">
            {{ status.distribution.mother_out_date.strftime('%B %d, %Y') }}
        </div>
        <div class="label">Status:</div>
        <div class="value {% if status.distribution.is_out %}danger{% elif status.distribution.days_until_out <= 3 %}warning{% else %}success{% endif %}">
            {% if status.distribution.is_out %}
                ğŸš¨ OUT OF PILLS!
            {% elif status.distribution.days_until_out == 0 %}
                âš ï¸  RUNS OUT TODAY!
            {% elif status.distribution.days_until_out == 1 %}
                âš ï¸  RUNS OUT TOMORROW!
            {% elif status.distribution.days_until_out <= 3 %}
                â° RUNS OUT IN {{ status.distribution.days_until_out }} DAYS
            {% else %}
                âœ“ {{ status.distribution.days_until_out }} DAYS REMAINING
            {% endif %}
        </div>
        <div class="label">Pills with Father:</div>
        <div class="value success">{{ status.distribution.pills_with_father }} pills</div>
        
        {% if next_distribution %}
        <!-- Next Distribution (integrated) -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--terminal-green);">
            <div class="label">ğŸ“… Next Distribution:</div>
            <div class="value {% if next_distribution.days_until == 0 %}danger{% elif next_distribution.days_until <= 2 %}warning{% else %}info{% endif %}">
                {{ next_distribution.date.strftime('%b %d, %Y') }}
                {% if next_distribution.days_until == 0 %}
                    (TODAY!)
                {% elif next_distribution.days_until == 1 %}
                    (TOMORROW!)
                {% else %}
                    ({{ next_distribution.days_until }} days)
                {% endif %}
            </div>
            <div class="label">Give Her:</div>
            <div class="value info">{{ next_distribution.quantity }} pills</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Action Buttons -->
<div class="terminal-window">
    <h2>>> QUICK ACTIONS</h2>
    <div class="button-group">
        <a href="/fill/new" class="button">ğŸ“ RECORD NEW FILL</a>
        <a href="/distribution/new" class="button">ğŸ’Š RECORD DISTRIBUTION</a>
        <a href="/calendar/sync" class="button">ğŸ“… SYNC CALENDAR</a>
        <a href="/history" class="button">ğŸ“œ VIEW HISTORY</a>
    </div>
</div>

{% if status.distribution and (status.distribution.is_out or status.distribution.days_until_out <= 2) %}
<div class="alert {% if status.distribution.is_out %}danger{% else %}warning{% endif %}">
    ğŸ¯ ACTION REQUIRED: {% if status.distribution.is_out %}Mother is OUT of pills!{% else %}Mother running low on pills!{% endif %}
    {% if status.refill.can_refill %}
    <br>âœ… You can refill NOW!
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="terminal-window">
    <h2>>> SYSTEM INITIALIZATION REQUIRED</h2>
    <p>No data found in system. Please initialize by recording your first prescription fill.</p>
    <div class="button-group">
        <a href="/fill/new" class="button">ğŸ“ RECORD FIRST FILL</a>
    </div>
</div>
{% endif %}

{% endblock %}
